name: Quality_Gate_Senior_Final

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  CARGO_TERM_COLOR: always
  # Variables necesarias para los tests de integraciÃ³n en la nube de GitHub
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
  HUGGINGFACE_KEY: ${{ secrets.HUGGINGFACE_KEY }}

jobs:
  guardian:
    name: Validar_Infraestructura
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Clonar cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ¦€ Configurar Rust (Cacheado para velocidad)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: ğŸ“ Paso 1: Formatter (EstÃ©tica Perfecta)
        run: cargo fmt --all -- --check

      - name: ğŸ” Paso 2: Linter (CÃ³digo Senior)
        run: cargo clippy -- -D warnings

      - name: ğŸ§ª Paso 3: Tests Unitarios (LÃ³gica)
        run: cargo test --lib --bins

      - name: ğŸ”— Paso 4: Tests de IntegraciÃ³n (ConexiÃ³n Real)
        run: cargo test --test '*'
        # Este paso verifica que Rust hable con Supabase y HuggingFace

      - name: âš¡ Paso 5: Test de EstrÃ©s (Resiliencia)
        # Usar Docker para no instalar nada extra
        run: |
          docker run --rm -i grafana/k6 run - < stress_test.js

      deploy:
          name: Despliegue_Automatico
          needs: guardian # <--- Solo corre si el guardian aprueba todo
          runs-on: ubuntu-latest
          if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

          steps:
            - name: ğŸ“¥ Clonar codigo
              uses: actions/checkout@v4

            - name: ğŸš€ Desplegar en Vercel
              uses: amondnet/vercel-action@v20
              with:
                vercel-token: ${{ secrets.VERCEL_TOKEN }}
                vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
                vercel-project_id: ${{ secrets.VERCEL_PROJECT_ID }}
                vercel-args: '--prod' # Despliegue directo a producciÃ³n    